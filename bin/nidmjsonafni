#!/usr/bin/python
"""
Export neuroimaging results created with FSL feat following NIDM-Results

DC code convergence
"""
import json
import sys
from subprocess import check_call

# nidmjsonafni ttest++_result+tlrc.BRIK

if __name__ == "__main__":
    # Remove first argument (script name)
    num_args = len(sys.argv)-1
    sys.argv.pop(0)
    args = sys.argv

    usage = "Usage: nidmafni path/to/feat/dir"

    if num_args != 1:
        raise Exception(usage)

    resbrik = args[0]
    print(resbrik)

    nidm = {}
    nidm['NeuroimagingAnalysisSoftware_type'] = "AFNI"
    # Is the version of AFNI that was used for the analysis stored somwhere?
    nidm['NeuroimagingAnalysisSoftware_softwareVersion'] = "TODO"
    # TODO rethink in NIDM
    # nidm['nidm_grandMeanScaling']
    nidm['nidm_targetIntensity'] = 100
    nidm['DesignMatrix_atLocation'] = "TODO"
    nidm['DesignMatrix_regressorNames'] = ["group"]

    check_call([
        # 3dAFNItoNIFTI -prefix <NAME> <RES_BRIK>[0]
        '3dAFNItoNIFTI', '-prefix', 'ParameterEstimate', resbrik + '[0]'])
    nidm['ParameterEstimateMaps'] = ["ParameterEstimate.nii"]
    nidm['ErrorModel_hasErrorDistribution'] = "obo_NormalDistribution"
    nidm['ErrorModel_errorVarianceHomogeneous'] = True
    # TODO:  check
    nidm['ErrorModel_varianceMapWiseDependence'] = "nidm_IndependentParameter"
    nidm['ErrorModel_hasErrorDependence'] = "nidm_IndependentError"
    nidm['ErrorModel_depemdenceMapWiseDependence'] = \
        "nidm_IndependentParameter"
    nidm['ModelParameterEstimation_withEstimationMethod'] = \
        "obo_OrdinaryLeastSquaresEstimation"

    # TODO residualmeansquares
    nidm['ResidualMeanSquaresMap_atLocation'] = "TODO"
    # TODO GrandMeanMap --> not needed
    nidm['GrandMeanMap_atLocation'] = "TODO"

    # TODO MaskMap_atLocation
    nidm['MaskMap_atLocation'] = "TODO"

    # TODO CoordinateSpace_inWorldCoordinateSystem
    nidm['CoordinateSpace_inWorldCoordinateSystem'] = "TODO"

    nidm['Contrasts'] = []
    check_call([
        # 3dAFNItoNIFTI -prefix <NAME> <RES_BRIK>[0]
        '3dAFNItoNIFTI', '-prefix', 'Contrast', resbrik + '[0]'])
    check_call([
        # 3dAFNItoNIFTI -prefix <NAME> <RES_BRIK>[1]
        '3dAFNItoNIFTI', '-prefix', 'TStatistic', resbrik + '[1]'])

    nidm['Contrasts'].append({
            # TODO: do we want specific names?
            "StatisticMap_contrastName": "group",
            "ContrastWeightMatrix_value": [1],
            "StatisticMap_statisticType": "obo_TStatistic",
            # degrees of freedom
            "StatisticMap_errorDegreesOfFreedom": "TODO",
            "StatisticMap_atLocation": "TStatistic.nii",
            # TODO inworldcoordsyst
            "StatisticMap_inWorldCoordinateSystem": "TODO",
            "ContrastMap_atLocation": "Contrast.nii",
            # TODO inworldcoordsyst
            "ContrastMap_inWorldCoordinateSystem": "TODO",
            # TODO ContrastStandardErrorMap_atLocation
            "ContrastStandardErrorMap_atLocation": "TODO"
        })
    # TODO connectivity criterion
    nidm['ClusterDefinitionCriteria_hasConnectivityCriterion'] = "TODO"
    # TODO PeakDefinitionCriteria_minDistanceBetweenPeaks
    nidm['PeakDefinitionCriteria_minDistanceBetweenPeaks'] = "TODO"
    # TODO PeakDefinitionCriteria_maxNumberOfPeaksPerCluster
    nidm['PeakDefinitionCriteria_maxNumberOfPeaksPerCluster'] = "TODO"

    print(json.dumps(nidm, indent=4))
